-------------------------------------------------------------------------------------------------
# INSTALL
-------------------------------------------------------------------------------------------------
./install.sh

-------------------------------------------------------------------------------------------------
# TEST K8S AUTH FOR VAULT AFTER INSTALL
-------------------------------------------------------------------------------------------------
kubectl run tmp --rm -i --tty --serviceaccount=postgres-vault --image alpine

apk update && \
apk add curl postgresql-client jq && \
KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) && \
VAULT_K8S_LOGIN=$(curl --request POST --data '{"jwt": "'"$KUBE_TOKEN"'", "role": "postgres"}' http://vault:8200/v1/auth/kubernetes/login) && \
X_VAULT_TOKEN=$(echo $VAULT_K8S_LOGIN | jq -r '.auth.client_token') && \
POSTGRES_CREDS=$(curl --header "X-Vault-Token: $X_VAULT_TOKEN" http://vault:8200/v1/database/creds/postgres-role) && \
PGUSER=$(echo $POSTGRES_CREDS | jq -r '.data.username') && \
PGPASSWORD=$(echo $POSTGRES_CREDS | jq -r '.data.password') && \
psql -h pgxl-postgres-xl-svc -U $PGUSER postgres -c 'SELECT * FROM pg_catalog.pg_tables;'

-------------------------------------------------------------------------------------------------
# DELETE
-------------------------------------------------------------------------------------------------
./delete.sh

-------------------------------------------------------------------------------------------------
# DELETE CONSUL PVC
-------------------------------------------------------------------------------------------------
./delete_consul_pvc.sh
